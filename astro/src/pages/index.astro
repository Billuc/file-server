---
import SearchBar from "@/components/SearchBar.astro";
import Layout from "@/layouts/Layout.astro";
---

<Layout title="File Server">
  <h1 class="home-title">Welcome to the File Server</h1>
  <SearchBar />
  <div class="upload-section">
    <button id="upload-button" class="upload-button">Upload File</button>
    <input type="file" id="file-input" style="display: none;" />
    <div id="password-section" class="password-section" style="display: none;">
      <label for="file-password">Password (optional):</label>
      <input type="password" id="file-password" placeholder="Enter password" />
    </div>
  </div>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const uploadButton = document.getElementById("upload-button")!;
    const fileInput = document.getElementById("file-input")!;
    const passwordSection = document.getElementById("password-section")!;
    const passwordInput = document.getElementById("file-password")!;

    uploadButton.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", async (event) => {
      const file = (event.target as HTMLInputElement).files?.[0];
      if (!file) return;

      // Show password section when file is selected
      passwordSection.style.display = "block";

      try {
        const formData = new FormData();
        formData.append("file", file);
        
        // Add password if provided
        if (passwordInput.value) {
          formData.append("password", passwordInput.value);
        }

        const response = await fetch("/upload", {
          method: "POST",
          body: formData,
          // Don't set Content-Type header - let browser handle it for FormData
        });

        if (response.ok) {
          const result = await response.json();
          window.location.href = `/${result.key}`;
        } else {
          throw new Error("Upload failed");
        }
      } catch (error) {
        console.error("Error uploading file:", error);
        alert("Error uploading file. Please try again.");
      }
    });
  });
</script>
